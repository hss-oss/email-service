# ğŸ“§ Cloudflare Serverless ä¸´æ—¶é‚®ä»¶æœåŠ¡

è¿™æ˜¯ä¸€ä¸ªåŸºäº Cloudflare å…¨å®¶æ¡¶ï¼ˆWorkers, D1, Email Routingï¼‰æ­å»ºçš„ã€åŠŸèƒ½å®Œæ•´çš„ä¸ªäººä¸´æ—¶é‚®ä»¶æ¥æ”¶æœåŠ¡ã€‚

## ğŸš€ åœ¨çº¿æ¼”ç¤º

* **æ™®é€šç”¨æˆ·å…¥å£:** [**â¡ï¸ ç‚¹å‡»è¿™é‡Œè®¿é—®: mail.tienshan.edu.kg**](https://mail.tienshan.edu.kg)

* **ç®¡ç†å‘˜å…¥å£:** [**â¡ï¸ ç‚¹å‡»è¿™é‡Œè®¿é—® (ç®¡ç†å‘˜)**](https://mail.tienshan.edu.kg/?admin=6242a64b-a151-4531-820b-2009899775cd)

## ğŸŒŸ ä¸»è¦åŠŸèƒ½

* **æƒé™ç®¡ç†**: åŒºåˆ†**ç®¡ç†å‘˜**å’Œ**æ™®é€šç”¨æˆ·**ä¸¤ç§è§’è‰²ã€‚

* **è´¦æˆ·ç³»ç»Ÿ**:

  * ç®¡ç†å‘˜æ‹¥æœ‰æ‰€æœ‰æƒé™ï¼Œå¯ä»¥åˆ›å»ºæ–°çš„é‚®ç®±è´¦æˆ·ã€‚

  * æ¯ä¸ªæ–°è´¦æˆ·éƒ½æœ‰ä¸€ä¸ªç‹¬ç«‹çš„é‚®ç®±ç å’Œåˆå§‹å¯†ç ã€‚

* **å®‰å…¨ç™»å½•**: æ™®é€šç”¨æˆ·å¿…é¡»å‡­**é‚®ç®±ç å’Œå¯†ç **æ‰èƒ½ç™»å½•å’ŒæŸ¥çœ‹é‚®ä»¶ã€‚

* **å¯†ç ä¿®æ”¹**: æ™®é€šç”¨æˆ·ç™»å½•åå¯ä»¥ä¿®æ”¹è‡ªå·±çš„å¯†ç ï¼Œæå‡è´¦æˆ·å®‰å…¨æ€§ã€‚

* **çº¯äº‘ç«¯ Serverless æ¶æ„**ï¼šæ‰€æœ‰æœåŠ¡å‡è¿è¡Œåœ¨ Cloudflare çš„å…¨çƒè¾¹ç¼˜ç½‘ç»œï¼Œæ— éœ€è´­ä¹°å’Œç®¡ç†æœåŠ¡å™¨ã€‚

* **ç°ä»£åŒ–ç•Œé¢**ï¼šä½¿ç”¨ Tailwind CSS å’Œå›¾æ ‡åº“æ„å»ºï¼Œæä¾›æµç•…çš„ç”¨æˆ·ä½“éªŒå’Œç¾è§‚çš„æç¤ºã€‚

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

* **é‚®ä»¶æ¥æ”¶**: Cloudflare Email Routing

* **åç«¯é€»è¾‘ä¸ API**: Cloudflare Workers

* **æ•°æ®åº“**: Cloudflare D1

* **å‰ç«¯ç•Œé¢**: é€šè¿‡ Worker åŠ¨æ€ç”Ÿæˆçš„ HTML / Tailwind CSS / Vanilla JavaScript

* **éƒ¨ç½²ä¸ç®¡ç†**: Cloudflare Wrangler CLI / Git-driven Deployment

* **é‚®ä»¶è§£æ**: `postal-mime`

## ğŸš€ éƒ¨ç½²æŒ‡å—

æˆ‘ä»¬æä¾›ä¸¤ç§éƒ¨ç½²æ–¹å¼ï¼Œæ¨èä½¿ç”¨å¯¹æ–°æ‰‹æœ€å‹å¥½çš„â€œé€šè¿‡ GitHub éƒ¨ç½²â€ã€‚

### A) é€šè¿‡ GitHub éƒ¨ç½² (æ¨èï¼Œæ— éœ€æœ¬åœ°ç¯å¢ƒ)

æ­¤æ–¹æ³•åˆ©ç”¨ GitHub å’Œ Cloudflare çš„é›†æˆï¼Œå®ç°å…¨è‡ªåŠ¨éƒ¨ç½²ï¼Œ**æ— éœ€åœ¨æ‚¨çš„ç”µè„‘ä¸Šå®‰è£…ä»»ä½•å¼€å‘å·¥å…·**ã€‚

**ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡ GitHub ä»“åº“**

1. ç™»å½•æ‚¨çš„ GitHub è´¦æˆ·ã€‚

2. **Fork æœ¬é¡¹ç›®**ï¼šç‚¹å‡»æœ¬é¡¹ç›®é¡µé¢å³ä¸Šè§’çš„ "Fork" æŒ‰é’®ï¼Œå°†æ­¤é¡¹ç›®å¤åˆ¶åˆ°æ‚¨è‡ªå·±çš„ GitHub è´¦æˆ·ä¸‹ã€‚

**ç¬¬äºŒæ­¥ï¼šåˆ›å»º D1 æ•°æ®åº“**

1. ç™»å½• Cloudflare ä»ªè¡¨æ¿ï¼Œè¿›å…¥å·¦ä¾§èœå•çš„ **Workers & Pages** -> **D1** æ ‡ç­¾é¡µã€‚

2. ç‚¹å‡» **â€œåˆ›å»ºæ•°æ®åº“ (Create database)â€**ï¼Œåç§°å¡«å†™ `email_db`ï¼Œç„¶ååˆ›å»ºã€‚

3. åˆ›å»ºåï¼Œ**å¤åˆ¶å¹¶ä¿å­˜å¥½**è¿™ä¸ªæ•°æ®åº“çš„ **ID** (ä¾‹å¦‚ `xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx`)ï¼Œä¸‹ä¸€æ­¥ä¼šç”¨åˆ°ã€‚

**ç¬¬ä¸‰æ­¥ï¼šè¿æ¥ GitHub å¹¶åˆ›å»ºåº”ç”¨**

1. åœ¨ Cloudflare ä»ªè¡¨æ¿ï¼Œè¿›å…¥ **Workers & Pages**ï¼Œç‚¹å‡» **â€œåˆ›å»ºåº”ç”¨ç¨‹åº (Create Application)â€**ã€‚

2. é€‰æ‹© **â€œè¿æ¥åˆ° Git (Connect to Git)â€**ã€‚

3. é€‰æ‹©æ‚¨åˆšåˆš Fork çš„é¡¹ç›®ä»“åº“ï¼Œå¹¶æˆæƒ Cloudflare è®¿é—®ã€‚

4. åœ¨â€œæ„å»ºå’Œéƒ¨ç½²è®¾ç½®â€é¡µé¢ï¼š

   * **ç”Ÿäº§åˆ†æ”¯ (Production branch)**: ç¡®ä¿é€‰æ‹© `main`ã€‚

   * **æ„å»ºå‘½ä»¤ (Build command)**: å¡«å†™ `npm install`ã€‚

   * **æ„å»ºè¾“å‡ºç›®å½• (Build output directory)**: ä¿æŒä¸º `/`ã€‚

5. ç‚¹å‡» **â€œä¿å­˜å¹¶éƒ¨ç½² (Save and Deploy)â€**ã€‚Cloudflare ä¼šè¿›è¡Œç¬¬ä¸€æ¬¡éƒ¨ç½²ï¼ˆæ­¤æ—¶ä¼šå› ä¸ºç¼ºå°‘é…ç½®è€Œæ— æ³•æ­£å¸¸å·¥ä½œï¼Œè¿™æ˜¯æ­£å¸¸çš„ï¼‰ã€‚

**ç¬¬å››æ­¥ï¼šé…ç½® Worker**

1. éƒ¨ç½²å®Œæˆåï¼Œè¿›å…¥æ–°åˆ›å»ºçš„ `email-service` åº”ç”¨çš„ç®¡ç†é¡µé¢ï¼Œç‚¹å‡» **â€œè®¾ç½® (Settings)â€** æ ‡ç­¾é¡µã€‚

2. è¿›å…¥ **â€œç¯å¢ƒå˜é‡ (Environment Variables)â€**ï¼Œç‚¹å‡» **â€œæ·»åŠ å˜é‡ (Add variable)â€**ï¼š

   * **`MY_DOMAIN`**: å˜é‡å€¼å¡«å†™ä½ çš„åŸŸåï¼Œä¾‹å¦‚ `tianshan.edu.kg`ã€‚

   * **`ADMIN_UUID`**: è‡ªå·±ç”Ÿæˆä¸€ä¸ª [UUID](https://www.uuidgenerator.net/) å¹¶ç²˜è´´åˆ°å€¼ä¸­ï¼ˆè¿™æ˜¯ä½ çš„ç®¡ç†å‘˜å¯†ç ï¼‰ã€‚

3. åœ¨åŒä¸€é¡µé¢ï¼Œå‘ä¸‹æ»šåŠ¨åˆ° **â€œD1 æ•°æ®åº“ç»‘å®š (D1 Database Bindings)â€**ï¼Œç‚¹å‡» **â€œæ·»åŠ ç»‘å®š (Add binding)â€**ï¼š

   * å˜é‡åç§°å¡«å†™ `DB`ã€‚

   * D1 æ•°æ®åº“é€‰æ‹© `email_db`ã€‚

4. ä¿å­˜æ‰€æœ‰ç»‘å®šå’Œå˜é‡ã€‚

**ç¬¬äº”æ­¥ï¼šåˆå§‹åŒ–æ•°æ®åº“è¡¨**

1. å›åˆ° `email-service` åº”ç”¨çš„ç®¡ç†é¡µé¢ï¼Œç‚¹å‡» **â€œD1 æ•°æ®åº“â€** æ ‡ç­¾é¡µã€‚

2. ä½ åº”è¯¥èƒ½çœ‹åˆ°ç»‘å®šçš„ `email_db`ã€‚ç‚¹å‡»è¿›å…¥å®ƒçš„ **â€œæ§åˆ¶å° (Console)â€**ã€‚

3. å°†é¡¹ç›®æ ¹ç›®å½•ä¸‹ **`schema.sql`** æ–‡ä»¶ä¸­çš„ SQL ä»£ç å®Œæ•´åœ°ç²˜è´´åˆ°è¾“å…¥æ¡†ä¸­ï¼Œç„¶åç‚¹å‡» **â€œæ‰§è¡Œ (Execute)â€**ã€‚

**ç¬¬å…­æ­¥ï¼šé…ç½®é‚®ä»¶è·¯ç”±**

1. åœ¨ Cloudflare ä»ªè¡¨æ¿ï¼Œé€‰æ‹©ä½ çš„åŸŸåã€‚

2. è¿›å…¥ **Email > Email Routing** -> **Routes (è·¯ç”±)**ã€‚

3. æ‰¾åˆ° **Catch-all address (å…¨åŒ¹é…åœ°å€)**ï¼Œå¯ç”¨å®ƒã€‚

4. å°†å…¶ **Action (æ“ä½œ)** è®¾ç½®ä¸º **Send to a Worker (å‘é€åˆ° Worker)**ã€‚

5. å°† **Destination (ç›®æ ‡ä½ç½®)** é€‰æ‹©ä¸ºä½ çš„ Workerï¼š`email-service`ã€‚

6. ä¿å­˜è®¾ç½®ã€‚

è‡³æ­¤ï¼Œæ‚¨çš„åº”ç”¨å·²å®Œå…¨é…ç½®å¹¶éƒ¨ç½²æˆåŠŸï¼è®¿é—® Worker æä¾›çš„ URL å³å¯å¼€å§‹ä½¿ç”¨ã€‚

### B) æœ¬åœ°å¼€å‘éƒ¨ç½²æŒ‡å— (é€‚ç”¨äºå¼€å‘è€…)

æ­¤æ–¹æ³•éœ€è¦æ‚¨åœ¨æœ¬åœ°ç”µè„‘ä¸Šå®‰è£… [Node.js](https://nodejs.org/)ã€[Git](https://git-scm.com/) å’Œ [Wrangler CLI](https://developers.cloudflare.com/workers/wrangler/install-and-update/)ï¼Œé€‚åˆéœ€è¦è¿›è¡Œä»£ç ä¿®æ”¹å’Œç‰ˆæœ¬æ§åˆ¶çš„åœºæ™¯ã€‚

1. **å®‰è£… Wrangler**

   ```bash
   npm install -g wrangler
   ```

2. **å…‹éš†æˆ–å‡†å¤‡å¥½é¡¹ç›®æ–‡ä»¶**
   å°†æœ¬é¡¹ç›®çš„ä»£ç å®Œæ•´åœ°ä¸‹è½½æˆ–å…‹éš†åˆ°æ‚¨çš„æœ¬åœ°ç”µè„‘ã€‚

3. **å®‰è£…ä¾èµ– (å…³é”®æ­¥éª¤)**
   åœ¨é¡¹ç›®æ–‡ä»¶å¤¹çš„ç»ˆç«¯ä¸­ï¼Œè¿è¡Œ `npm install`ã€‚

4. **åˆ›å»º D1 æ•°æ®åº“**
   è¿è¡Œ `wrangler d1 create email_db` å¹¶å¤åˆ¶ä¿å­˜å¥½è¿”å›çš„ `database_id`ã€‚

5. **é…ç½® `wrangler.jsonc`**
   å‚è€ƒé¡¹ç›®ä¸­çš„ `wrangler.jsonc` æ–‡ä»¶ï¼Œå¡«å…¥æ‚¨è‡ªå·±çš„ `name`, `database_id` å’Œ `MY_DOMAIN` ç­‰ä¿¡æ¯ã€‚

6. **åˆå§‹åŒ–æ•°æ®åº“è¡¨ç»“æ„**
   è¿è¡Œ `wrangler d1 execute email_db --file=./schema.sql --remote`ã€‚

7. **é…ç½®é‚®ä»¶è·¯ç”±** (åŒä¸Š)ã€‚

8. **éƒ¨ç½² Workerï¼**
   è¿è¡Œ `wrangler deploy` å‘½ä»¤è¿›è¡Œéƒ¨ç½²ã€‚